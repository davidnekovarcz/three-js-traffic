<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Run - Final Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
        
        #score {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        #status {
            font-size: 14px;
            color: #0f0;
        }
        
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            display: none;
            z-index: 1000;
        }
        
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            max-width: 300px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="score">Loading...</div>
        <div id="status">Initializing game...</div>
    </div>
    
    <div id="error">
        <h3>Game Error</h3>
        <div id="error-message"></div>
    </div>
    
    <div id="instructions">
        <strong>Controls:</strong><br>
        ↑ - Accelerate / Start<br>
        ↓ - Decelerate<br>
        ← → - Switch lanes<br>
        SPACE - Pause<br>
        R - Reset
    </div>
    
    <script type="module">
        const scoreEl = document.getElementById('score');
        const statusEl = document.getElementById('status');
        const errorEl = document.getElementById('error');
        const errorMessageEl = document.getElementById('error-message');
        
        function updateStatus(message) {
            statusEl.textContent = message;
            console.log('Status:', message);
        }
        
        function showError(message, error = null) {
            errorMessageEl.textContent = message;
            if (error) {
                errorMessageEl.textContent += '\n\n' + error.stack;
            }
            errorEl.style.display = 'block';
            console.error('Game Error:', message, error);
        }
        
        async function initializeGame() {
            try {
                updateStatus('Loading core modules...');
                
                // Import game modules
                const { TrafficRunGame } = await import('../src/core/Game.js');
                const { eventBus, GameEvents } = await import('../src/core/EventBus.js');
                
                updateStatus('Creating game instance...');
                const game = new TrafficRunGame();
                
                // Setup event listeners for UI updates
                eventBus.on(GameEvents.SCORE_UPDATE, (data) => {
                    scoreEl.textContent = `Score: ${data.score}`;
                });
                
                eventBus.on(GameEvents.GAME_START, () => {
                    updateStatus('Game running - Use arrow keys to play!');
                });
                
                eventBus.on(GameEvents.GAME_PAUSE, () => {
                    updateStatus('Game paused - Press SPACE to resume');
                });
                
                eventBus.on(GameEvents.GAME_RESUME, () => {
                    updateStatus('Game resumed');
                });
                
                eventBus.on(GameEvents.GAME_OVER, () => {
                    updateStatus('Game Over - Press R to reset');
                });
                
                eventBus.on(GameEvents.SYSTEM_ERROR, (data) => {
                    showError('System error: ' + data.error.message, data.error);
                });
                
                updateStatus('Initializing game...');
                await game.init();
                
                updateStatus('Game ready! Press ↑ to start');
                scoreEl.textContent = 'Press ↑ to start';
                
                // Make game globally accessible for debugging
                window.game = game;
                
                // Auto-start the game for testing
                setTimeout(() => {
                    if (game && !game.state.ready) {
                        game.start();
                    }
                }, 2000);
                
                return game;
                
            } catch (error) {
                showError('Failed to initialize game: ' + error.message, error);
                throw error;
            }
        }
        
        // Start the game when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }
        
        // Handle page errors
        window.addEventListener('error', (event) => {
            showError('JavaScript error: ' + event.message, event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            showError('Unhandled promise rejection: ' + event.reason);
        });
    </script>
</body>
</html>