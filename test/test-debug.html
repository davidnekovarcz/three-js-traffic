<!DOCTYPE html>
<html>
<head>
    <title>Debug Game Initialization</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .module { 
            margin: 10px 0; 
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        pre { 
            background: #333; 
            padding: 10px; 
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Required HTML elements -->
    <div id="score" style="display: none;">Press UP</div>
    <div id="controls" style="display: none;">
        <div id="buttons">
            <button id="accelerate"></button>
            <button id="decelerate"></button>
        </div>
        <div id="instructions"></div>
    </div>
    <div id="results" style="display: none;"></div>
    <div id="pause-dialog" style="display: none;"></div>
    
    <h1>Traffic Run Debug Tool</h1>
    <div id="output"></div>
    
    <script type="module">
        const output = document.getElementById('output');
        let testsPassed = 0;
        let testsFailed = 0;
        
        function createModuleDiv(name) {
            const div = document.createElement('div');
            div.className = 'module';
            div.innerHTML = `<h3>${name}</h3><div class="content"></div>`;
            output.appendChild(div);
            return div.querySelector('.content');
        }
        
        function log(container, message, type = 'info') {
            container.innerHTML += `<p class="${type}">${message}</p>`;
            console.log(`[${type}] ${message}`);
        }
        
        async function testModule(name, path, container) {
            try {
                log(container, `Loading ${name}...`);
                const startTime = performance.now();
                const module = await import(path);
                const loadTime = (performance.now() - startTime).toFixed(2);
                log(container, `✓ Loaded in ${loadTime}ms`, 'success');
                
                // List exports
                const exports = Object.keys(module);
                if (exports.length > 0) {
                    log(container, `Exports: ${exports.join(', ')}`);
                }
                
                testsPassed++;
                return module;
            } catch (error) {
                log(container, `✗ Failed: ${error.message}`, 'error');
                if (error.stack) {
                    const relevantStack = error.stack.split('\n').slice(0, 5).join('\n');
                    container.innerHTML += `<pre>${relevantStack}</pre>`;
                }
                testsFailed++;
                throw error;
            }
        }
        
        async function runTests() {
            // Test Three.js
            const threeDiv = createModuleDiv('Three.js');
            try {
                const THREE = await testModule('Three.js', 'three', threeDiv);
                log(threeDiv, `Version: ${THREE.REVISION || 'unknown'}`);
            } catch (e) {
                log(threeDiv, 'Critical: Three.js failed to load', 'error');
                return;
            }
            
            // Test core modules in dependency order
            const modules = [
                { name: 'Config', path: './src/core/Config.js' },
                { name: 'Logger', path: './src/core/Logger.js' },
                { name: 'EventBus', path: './src/core/EventBus.js' },
                { name: 'Audio', path: './src/audio.js' },
                { name: 'Track', path: './src/track.js' },
                { name: 'Vehicles', path: './src/vehicles.js' },
                { name: 'UI', path: './src/ui.js' },
                { name: 'Collision', path: './src/collision.js' },
                { name: 'Renderer', path: './src/core/Renderer.js' }
            ];
            
            for (const mod of modules) {
                const modDiv = createModuleDiv(mod.name);
                try {
                    await testModule(mod.name, mod.path, modDiv);
                } catch (e) {
                    log(modDiv, `Stopping tests due to failure in ${mod.name}`, 'warning');
                    break;
                }
            }
            
            // Try to load and initialize the game
            const gameDiv = createModuleDiv('Game Module');
            try {
                const { TrafficRunGame } = await testModule('Game', './src/core/Game.js', gameDiv);
                
                log(gameDiv, 'Creating game instance...');
                const game = new TrafficRunGame();
                window.debugGame = game;
                log(gameDiv, '✓ Game instance created (available as window.debugGame)', 'success');
                
                log(gameDiv, 'Initializing game...');
                await game.init();
                log(gameDiv, '✓ Game initialized!', 'success');
                
                const state = game.getState();
                log(gameDiv, `State: ready=${state.ready}, paused=${state.paused}`, 'success');
                
            } catch (error) {
                log(gameDiv, `Game initialization failed: ${error.message}`, 'error');
            }
            
            // Summary
            const summaryDiv = createModuleDiv('Test Summary');
            log(summaryDiv, `Tests Passed: ${testsPassed}`, testsPassed > 0 ? 'success' : 'warning');
            log(summaryDiv, `Tests Failed: ${testsFailed}`, testsFailed > 0 ? 'error' : 'success');
            
            if (testsFailed === 0) {
                log(summaryDiv, '✓ All modules loaded successfully!', 'success');
                log(summaryDiv, 'The game should be working. Check the main page.', 'success');
            } else {
                log(summaryDiv, '✗ Some modules failed to load', 'error');
                log(summaryDiv, 'Fix the errors above before the game will work', 'warning');
            }
        }
        
        // Start tests
        console.log('Starting Traffic Run debug tests...');
        runTests().catch(error => {
            console.error('Fatal error during tests:', error);
        });
    </script>
</body>
</html>